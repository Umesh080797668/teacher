name: Build and Release APK

on:
  release:
    types: [published]

permissions:
  contents: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true
      
      - name: Install Android SDK components
        run: |
          sdkmanager "platform-tools" "platforms;android-36" "build-tools;34.0.0"
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Upload APK to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            ./build/app/outputs/flutter-apk/app-release.apk \
            --clobber \
            --repo ${{ github.repository }}
      
      - name: Update update.json
        run: |
          cat > update.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "downloadUrl": "https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/app-release.apk",
            "releaseNotes": "${{ github.event.release.body }}",
            "isForced": false
          }
          EOF
      
      - name: Commit and push update.json
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add update.json
          git commit -m "Update update.json for version ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Failed to push, continuing anyway"
