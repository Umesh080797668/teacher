# QR Scanner Debugging Guide

## Issue: QR Code Scanning Not Working

### Recent Improvements Added:

1. **Enhanced Debug Logging**
   - Logs every step of QR code processing
   - Shows parsed QR data
   - Logs WebSocket connection status
   - Tracks authentication flow

2. **Better Error Messages**
   - Specific error for each validation step
   - Connection status indicator in UI
   - Timeout handling (10 seconds)

3. **WebSocket Connection Monitoring**
   - Visual connection status in app bar (green dot = connected, red = disconnected)
   - Reconnection attempts (up to 5 times)
   - Connection error notifications

4. **QR Code Validation**
   - Checks for required fields: `type`, `sessionId`, `expiresAt`
   - Validates QR code type is `web-auth`
   - Checks expiration time
   - Verifies teacher is logged in
   - Ensures WebSocket is connected

---

## How to Debug:

### Step 1: Check Logs (logcat/flutter logs)

Run the app with logs visible:
```bash
flutter run
```

When scanning a QR code, look for these logs:

**✅ Good Flow:**
```
Connecting to WebSocket at: https://teacher-eight-chi.vercel.app
WebSocket connected successfully
QR Code scanned: {"type":"web-auth","sessionId":"...","expiresAt":...}
Parsed QR JSON: {type: web-auth, sessionId: xyz, expiresAt: 123456789}
Session ID: xyz, Expires at: 123456789
Teacher ID: TCH828985185
Device ID: 1734179025870
Sending authentication request...
Authentication request sent
Authentication successful: {...}
```

**❌ Common Errors:**

1. **No QR Data:**
```
No barcodes detected
```
→ Camera not detecting QR code, move closer or adjust lighting

2. **Invalid JSON:**
```
Error parsing QR code: FormatException...
```
→ QR code is not valid JSON

3. **Wrong Type:**
```
QR code type is not "web-auth": something-else
```
→ Scanning wrong QR code (not from web interface)

4. **Missing Fields:**
```
QR code missing required fields
```
→ Web interface generated incomplete QR code

5. **Expired:**
```
QR code has expired
```
→ QR code is too old, refresh web interface

6. **Not Connected:**
```
WebSocket not connected
```
→ Backend server unreachable

7. **Teacher Not Logged In:**
```
Teacher not logged in
```
→ User needs to login to the app first

8. **Timeout:**
```
Authentication timeout. Please try again.
```
→ Server not responding within 10 seconds

---

## Step 2: Verify Web Interface QR Code Format

The QR code generated by the web interface MUST have this exact format:

```json
{
  "type": "web-auth",
  "sessionId": "unique-session-id-string",
  "expiresAt": 1734179025870
}
```

**Requirements:**
- `type`: Must be exactly `"web-auth"`
- `sessionId`: Must be a non-empty string
- `expiresAt`: Must be a timestamp in milliseconds (future time)

---

## Step 3: Check Backend Server

### Is the backend running?

Test with curl:
```bash
curl https://teacher-eight-chi.vercel.app/api/health
```

Should return:
```json
{
  "status": "OK",
  "message": "Server is running",
  "timestamp": "2025-12-14T...",
  "mongoStatus": "connected"
}
```

### Check WebSocket endpoint:

The WebSocket connection uses the same URL: `https://teacher-eight-chi.vercel.app`

If this fails, the issue is with the backend deployment.

---

## Step 4: Test QR Code Format

### Generate a Test QR Code:

Use an online QR generator with this exact data:
```json
{"type":"web-auth","sessionId":"test123","expiresAt":9999999999999}
```

Scan it with the app. You should see:
- "Parsed QR JSON: {type: web-auth, sessionId: test123, expiresAt: 9999999999999}"
- Then likely "Authentication failed" (because sessionId doesn't exist on backend)

But the parsing should work!

---

## Step 5: Common Solutions

### Problem: "WebSocket not connected"

**Solution 1:** Check internet connection
```bash
ping teacher-eight-chi.vercel.app
```

**Solution 2:** Backend might be down - check Vercel deployment status

**Solution 3:** Firewall blocking WebSocket connections

---

### Problem: "Authentication timeout"

**Causes:**
1. Backend WebSocket handler not responding
2. Session ID not registered on backend
3. Network latency issues

**Check backend logs** on Vercel to see if `authenticate-qr` event is received

---

### Problem: Camera not detecting QR code

**Solutions:**
1. Ensure good lighting
2. Hold phone steady
3. Adjust distance (15-30 cm from QR code)
4. Clean camera lens
5. Make sure QR code is clear and not blurry
6. Try larger QR code size on web interface

---

### Problem: "Invalid QR code format"

**This means the QR code is not valid JSON**

Check:
1. Web interface is generating correct format
2. QR code is not corrupted
3. QR code is not truncated

---

## Step 6: Test Sequence

1. **Open app and login**
   - Verify teacher ID is saved
   - Check logs for "Teacher ID: TCH..."

2. **Go to QR Scanner**
   - Check app bar shows "Connected" with green dot
   - If red dot, wait a few seconds for reconnection
   - Check logs for "WebSocket connected successfully"

3. **Open web interface** in browser
   - Generate QR code
   - Verify QR code appears

4. **Scan QR code**
   - Point camera at QR code
   - Hold steady for 1-2 seconds
   - Check logs for scanning activity

5. **Watch for result**
   - Success: "Successfully connected to web interface!"
   - Error: Specific error message with reason

---

## Log Analysis Commands

### View Flutter logs:
```bash
flutter logs
```

### Filter for QR scanner:
```bash
flutter logs | grep -i "qr\|websocket\|auth"
```

### View only errors:
```bash
flutter logs | grep -E "ERROR|Exception|Error"
```

---

## Quick Fixes

### Force WebSocket Reconnection:
1. Close QR Scanner screen
2. Wait 2 seconds
3. Reopen QR Scanner
4. Check connection status

### Clear App Data:
```bash
flutter clean
flutter pub get
flutter run
```

### Restart Backend:
If you have access to the backend:
```bash
cd backend
node server.js
```

---

## Still Not Working?

### Collect Debug Info:

1. **App Version:** Check pubspec.yaml version
2. **Flutter Logs:** Save full log output
3. **Backend Logs:** Check Vercel function logs
4. **QR Code Data:** Screenshot of QR code
5. **Error Message:** Exact error shown to user
6. **Connection Status:** Red or green dot in app bar?
7. **Teacher ID:** Check if logged in

### Report Issue:

Include:
- Device model and Android version
- Steps to reproduce
- Complete log output
- Screenshots
- Network conditions (WiFi/Mobile data)

---

## Technical Details

### WebSocket Configuration:
```dart
IO.io(backendUrl, {
  'transports': ['websocket'],
  'autoConnect': true,
  'reconnection': true,
  'reconnectionAttempts': 5,
  'reconnectionDelay': 1000,
});
```

### Authentication Flow:
1. Mobile scans QR → Extracts sessionId
2. Mobile sends to backend: `{sessionId, teacherId, deviceId}`
3. Backend validates sessionId exists
4. Backend emits `auth-success` or `auth-failed`
5. Mobile shows result to user

### Timeout:
- 10 seconds after sending authentication request
- Can be adjusted if network is slow

---

## Expected Behavior

### Successful Scan:
1. Camera detects QR code
2. App parses JSON data
3. Validates all fields
4. Checks WebSocket connection
5. Sends authentication request
6. Shows "Authenticating..." dialog
7. Receives response from server
8. Shows "Success!" message
9. Closes scanner, returns to previous screen

### Failed Scan:
1. Camera detects QR code
2. App parses JSON data
3. Validation fails at some step
4. Shows specific error message
5. User can try again

---

## Performance Notes

- QR scanning runs at camera frame rate (~30 fps)
- Only one QR code processed at a time (`_isProcessing` flag)
- Camera resources properly released on dispose
- WebSocket maintains persistent connection
- Automatic reconnection on connection loss
